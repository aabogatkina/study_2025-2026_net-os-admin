---
# Preamble

## Author
author:
  name: Богаткина Алёна Александровна
  degrees: DSc
  email: 1132231437@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: Презентация по лабораторной работе №10
subtitle: Администрирование сетевых подситем
license: CC BY
date: 2025-11-04

## Generic options
lang: ru-RU
crossref:
  lof-title: Список иллюстраций
  lot-title: Список таблиц
  lol-title: Листинги

## Fonts 
mainfont: DejaVu Sans
romanfont: DejaVu Sans 
sansfont: DejaVu Sans 
monofont: DejaVu Sans Mono 
mainfontoptions: Ligatures=TeX 
romanfontoptions: Ligatures=TeX 
sansfontoptions: Ligatures=TeX,Scale=MatchLowercase 
monofontoptions: Scale=MatchLowercase,Scale=0.9

## Formats
format:
### Pdf output format
  beamer:
    toc: true
    toc-title: Содержание
    number-sections: true
    colorlinks: false
    toc-depth: 2
    slide_level: 2
    aspectratio: 169
    section-titles: true
    theme: metropolis
    themeoptions: progressbar=frametitle,sectionpage=progressbar,numbering=fraction
    pdf-engine: xelatex
    fontenc: T2A
#### Language
    babel-lang: russian
    babel-otherlangs: english

### Html output
  revealjs:
    transition: slide
    margin: 0.2
    smaller: false
    output-ext: html
    theme: beige
    logo: _resources/image/logo_rudn.png
---

# Вводная часть

## Цель работы

Приобретение практических навыков по конфигурированию SMTP-сервера в части настройки аутентификации.

# Выполнение лабораторной работы

## Настройка LMTP в Dovecote

Загрузили нашу операционную систему и перешли в рабочий каталог с проектом. Запустили виртуальную машину server. Далее на виртуальной машине server вошли под созданным нами пользователем и открыли терминал. Перешли в режим суперпользователя: ```sudo -i``` ([рис. @fig-001])

![Переход в режим суперпользователя](image/1.png){#fig-001 width=70%}

## Настройка LMTP в Dovecote

Далее в дополнительном терминале запустили мониторинг работы почтовой службы: ```sudo -i``` и ```tail -f /var/log/maillog``` ([рис. @fig-002])

![Мониторинг почтовой службы](image/2.png){#fig-002 width=70%}

## Настройка LMTP в Dovecote

В конфигурационном файле /etc/dovecot/dovecot.conf добавили в список почтовых протоколов, по которым разрешено работать Dovecot, протокол LMTP: ```protocols = imap pop3 lmtp```([рис. @fig-003])

![Cписок почтовых протоколов, по которым разрешено работать Dovecot](image/3.png){#fig-003 width=70%}

## Настройка LMTP в Dovecote

Настроили в Dovecot сервис lmtp для связи с Postfix. Для этого в файле */etc/dovecot/conf.d/10-master.conf* заменили определение сервиса lmtp на следующую запись ([рис. @fig-004]):

![Редактирование файла /etc/dovecot/conf.d/10-master.conf (1)](image/4.png){#fig-004 width=50%}

## Настройка LMTP в Dovecote

Переопределили в Postfix с помощью postconf передачу сообщений не на прямую, а через заданный unix-сокет: ```postconf -e 'mailbox_transport = lmtp:unix:private/dovecot-lmtp'``` ([рис. @fig-005])

![Переопределение в Postfix передачи сообщений не напрямую, а через заданный unix-сокет](image/5.png){#fig-005 width=70%}

## Настройка LMTP в Dovecote

В файле */etc/dovecot/conf.d/10-auth.conf* задали формат имени пользователя для аутентификации в форме логина пользователя без указания домена: ```auth_username_format = %Ln``` ([рис. @fig-006])

![Редактирование файла /etc/dovecot/conf.d/10-auth.conf](image/6.png){#fig-006 width=70%}

## Настройка LMTP в Dovecote

Перезапустили Postfix и Dovecot ([рис. @fig-007]):

![Перезапуск Postfix и Dovecot](image/7.png){#fig-007 width=70%}

## Настройка LMTP в Dovecote

Далее запустили виртуальную машину client. Из-под учётной записи своего пользователя отправили письмо с клиента: ```echo .| mail -s "LMTP test" aabogatkina@aabogatkina.net``` ([рис. @fig-008])

![Отправка себе письма с клиента](image/8-1.png){#fig-008 width=70%}

## Настройка LMTP в Dovecote

В логах видно, что письмо от aabogatkina@client.aabogatkina.net было доставлено на почтовый ящик aabogatkina@aabogatkina.net через LMTP (протокол Dovecot) и сохранено в папке INBOX. Статус доставки: sent ([рис. @fig-009])

![Мониторинг работы почтовой службы (2)](image/8-2.png){#fig-009 width=70%}

## Настройка LMTP в Dovecote

На сервере просмотрели почтовый ящик пользователя и убедились что отправленное нами с клиента письмо доставлено в почтовый ящик: ```MAIL=~/Maildir/ mail``` ([рис. @fig-010])

![Просмотр почтового ящика на сервере](image/9.png){#fig-010 width=70%}

## Настройка SMTP-аутентификации

В файле */etc/dovecot/conf.d/10-master.conf* определили службу аутентификации пользователей ([рис. @fig-011]):

![Редактирование файла /etc/dovecot/conf.d/10-master.conf (2)](image/10.png){#fig-011 width=50%}

## Настройка SMTP-аутентификации

Для Postfix задали тип аутентификации SASL для smtpd и путь к соответствующему unix-сокету ([рис. @fig-012]):

![Задание для Postfix типа аутентификации SASL для smtpd и пути к соответствующему unix-сокету](image/11.png){#fig-012 width=70%}

## Настройка SMTP-аутентификации

Настроили Postfix для приёма почты из Интернета только для обслуживаемых нашим сервером пользователей или для произвольных пользователей локальной машины, обеспечивая тем самым запрет на использование почтового сервера в качестве SMTP relay для спамрассылок ([рис. @fig-013])

![Настройка Postfix для приёма почты из Интернета только для обслуживаемых нашим сервером пользователей](image/12.png){#fig-013 width=70%}

## Настройка SMTP-аутентификации

В настройках Postfix ограничили приём почты только локальным адресом SMTPсервера сети: ```postconf -e 'mynetworks = 127.0.0.0/8'``` ([рис. @fig-014])

![Ограничение приёма почты только локальным адресом SMTP-сервера сети](image/13.png){#fig-014 width=70%}

## Настройка SMTP-аутентификации

Для проверки работы аутентификации временно запустим SMTP-сервер (порт 25) с возможностью аутентификации. Для этого в файле */etc/postfix/master.cf* заменим строку ```smtp inet n - n - - smtpd``` на следующие ([рис. @fig-015]):

![Редактирование файла /etc/postfix/master.cf (1)](image/14.png){#fig-015 width=60%}

## Настройка SMTP-аутентификации

Перезапустили Postfix и Dovecot ([рис. @fig-016]): 

![Перезапуск Postfix и Dovecot](image/15.png){#fig-016 width=70%}

## Настройка SMTP-аутентификации

На клиенте установили telnet: ```sudo -i``` и ```dnf -y install telnet``` ([рис. @fig-017])

![Установка telnet на клиенте](image/16.png){#fig-017 width=50%}

## Настройка SMTP-аутентификации

На клиенте получили строку для аутентификации, указав логин нашего пользователя и пароль этого пользователя: ```printf 'aabogatkina\x00aabogatkina\x00123456' | base64``` ([рис. @fig-018])

![Получение строки для аутентификации](image/17.png){#fig-018 width=70%}

## Настройка SMTP-аутентификации

Далее подключились на клиенте к SMTP-серверу посредством telnet: ```telnet server.aabogatkina.net 25```. Протестировали соединение, введя ```EHLO test``` и проверили авторизацию, задав: ```AUTH PLAIN <string for authentification>``` ([рис. @fig-019])

![Подключение к SMTP-серверу посредством telnet](image/18.png){#fig-019 width=40%}

## Настройка SMTP over TLS

Предварительно скопировали необходимые файлы сертификата и ключа из каталога */etc/pki/dovecot* в каталог */etc/pki/tls/* в соответствующие подкаталоги ([рис. @fig-020]):

![Копирование файлов сертификата и ключа в определённые подкаталоги](image/19-1.png){#fig-020 width=70%}

## Настройка SMTP over TLS

Далее сконфигурировали Postfix, указав пути к сертификату и ключу, а также к каталогу для хранения TLS-сессий и уровень безопасности ([рис. @fig-021]):

![Конфигурация Postfix, указание путей к сертификату и ключу,  также к каталогу хранения TLS-сессий и уровень безопасности](image/19-2.png){#fig-021 width=70%}

## Настройка SMTP over TLS

Для того чтобы запустить SMTP-сервер на 587-м порту, в файле */etc/postfix/master.cf* заменили ранее написанные строки на эти ([рис. @fig-022]): 

![Редактирование файла /etc/postfix/master.cf (2)](image/20.png){#fig-022 width=70%}

## Настройка SMTP over TLS

Далее настроили межсетевой экран, разрешив работать службе smtp-submission ([рис. @fig-023]):

![Настройка межсетевого экрана, разрешение рабоать службе smtp-submission](image/21.png){#fig-023 width=60%}

## Настройка SMTP over TLS

Перезапустили Postfix: ```systemctl restart postfix``` ([рис. @fig-024])

![Перезапуск Postfix](image/22.png){#fig-024 width=70%}

## Настройка SMTP over TLS

На клиенте подключились к SMTP-серверу через 587-й порт посредством openssl: ```openssl s_client -starttls smtp -crlf -connect server.aabogatkina.net:587``` ([рис. @fig-025])

![Подключение к SMTP-серверу через 587-й порт посредством openssl](image/23-1.png){#fig-025 width=70%}

## Настройка SMTP over TLS

Протестировали подключение по telnet: ```EHLO test``` и проверили аутентификацию: ```AUTH PLAIN <string for authentification>``` ([рис. @fig-026])

![Тестирование подключения по telnet и проверка аутентификации](image/23-2.png){#fig-026 width=40%}

## Настройка SMTP over TLS

Далее в почтовом клиенте Evolution скорректировали настройки учётной записи, для SMTP-сервера указали порт 587, STARTTLS ([рис. @fig-027])

![Настройки учётной записи](image/24-1.png){#fig-027 width=40%}

## Настройка SMTP over TLS

Далее проверили корректность отправки почтовых сообщений с клиента посредством почтового клиента Evolution ([рис. @fig-028]), ([рис. @fig-029])

![Отправка почтового сообщения](image/24-2.png){#fig-028 width=40%}

## Настройка SMTP over TLS

![Просмотр пришедшего сообщения](image/24-3.png){#fig-029 width=50%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

На виртуальной машине server перешлм в каталог для внесения изменений в настройки внутреннего окружения */vagrant/provision/server/* и соответствующие подкаталоги поместили конфигурационные файлы Dovecot: ([рис. @fig-030]):

![Копирование конфигурационных файлов Dovecot в каталог dovecot](image/25.png){#fig-030 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

Далее внесли изменения в файл */vagrant/provision/server/mail.sh*, добавив в него строки по устанвке Dovecot и Telnet, по настройке межсетевого экрана,по настройке Postfix в части задания месторасположения почтового ящика, по перезапуску Postfix и запуску Dovecot ([рис. @fig-031]), ([рис. @fig-032]):

![Редактирование файла mail.sh на сервере (1)](image/26-1.png){#fig-031 width=30%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

![Редактирование файла mail.sh на сервере (1)](image/26-2.png){#fig-032 width=70%}

## Внесение изменений в настройки внутреннего окружения виртуальной машины

На виртуальной машине client в каталоге */vagrant/provision/client* скорректировали файл *mail.sh*, прописав в нём ```dnf -y install evolution``` ([рис. @fig-033]): 

![Редактирование файла mail.sh на клиенте](image/27.png){#fig-033 width=70%}

# Подведение итогов

## Выводы

В ходе выполнения лабораторной работы №10 мы приобрели практические навыки по конфигурированию SMTP-сервера в части настройки аутентификации.

## Список литературы

1. [Лаборатораня работа №10](https://esystem.rudn.ru/pluginfile.php/2854770/mod_resource/content/6/010-smtp-adv.pdf)
